{
  "version": 3,
  "sources": ["../../src/native.auth.client.ts"],
  "sourcesContent": ["import axios from \"axios\";\nimport { NativeAuthClientConfig } from \"./entities/native.auth.client.config\";\n\nexport class NativeAuthClient {\n  private readonly config: NativeAuthClientConfig;\n\n  constructor(config?: Partial<NativeAuthClientConfig>) {\n    this.config = Object.assign(new NativeAuthClientConfig(), config);\n  }\n\n  getToken(address: string, token: string, signature: string): string {\n    const encodedAddress = this.encodeValue(address);\n    const encodedToken = this.encodeValue(token);\n\n    const accessToken = `${encodedAddress}.${encodedToken}.${signature}`;\n    return accessToken;\n  }\n\n  async initialize(extraInfo: any = {}): Promise<string> {\n    const blockHash = await this.getCurrentBlockHash();\n    const encodedExtraInfo = this.encodeValue(JSON.stringify(extraInfo));\n    const origin = this.encodeValue(this.config.origin);\n\n    return `${origin}.${blockHash}.${this.config.expirySeconds}.${encodedExtraInfo}`;\n  }\n\n  async getCurrentBlockHash(): Promise<string> {\n    if (this.config.gatewayUrl) {\n      return await this.getCurrentBlockHashWithGateway();\n    }\n    return await this.getCurrentBlockHashWithApi();\n  }\n\n  private async getCurrentBlockHashWithGateway(): Promise<string> {\n    const round = await this.getCurrentRound();\n    const url = `${this.config.gatewayUrl}/blocks/by-round/${round}`;\n    const response = await this.get(url);\n    const blocks = response.data.data.blocks;\n    const block = blocks.filter(\n      (block: { shard: number }) => block.shard === this.config.blockHashShard\n    )[0];\n    return block.hash;\n  }\n\n  private async getCurrentRound(): Promise<number> {\n    if (!this.config.gatewayUrl) {\n      throw new Error(\"Gateway URL not set\");\n    }\n    if (!this.config.blockHashShard) {\n      throw new Error(\"Blockhash shard not set\");\n    }\n\n    const url = `${this.config.gatewayUrl}/network/status/${this.config.blockHashShard}`;\n    const response = await this.get(url);\n    const status = response.data.data.status;\n    return status.erd_current_round;\n  }\n\n  private async getCurrentBlockHashWithApi(): Promise<string> {\n    try {\n      const url = `${this.config.apiUrl}/blocks/latest?ttl=${this.config.expirySeconds}&fields=hash`;\n      const response = await this.get(url);\n      if (response.data[0].hash !== undefined) {\n        return response.data[0].hash;\n      }\n    } catch (error) {}\n    return this.getCurrentBlockHashWithApiFallback();\n  }\n\n  private async getCurrentBlockHashWithApiFallback(): Promise<string> {\n    let url = `${this.config.apiUrl}/blocks?size=1&fields=hash`;\n    if (this.config.blockHashShard !== undefined) {\n      url += `&shard=${this.config.blockHashShard}`;\n    }\n\n    const response = await this.get(url);\n    return response.data[0].hash;\n  }\n  encodeValue(str: string) {\n    return this.escape(Buffer.from(str, \"utf8\").toString(\"base64\"));\n  }\n\n  private escape(str: string) {\n    return str.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=/g, \"\");\n  }\n\n  private async get(url: string): Promise<any> {\n    return await axios.get(url, { headers: this.config.extraRequestHeaders });\n  }\n}\n"],
  "mappings": "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",
  "names": ["block", "axios"]
}
